# Modbus 模拟器前端设计规范

## 1. 整体架构概述

基于三层架构的 Modbus 设备管理界面，提供设备树导航和寄存器数据编辑功能。

### 1.1 界面布局
```
┌─────────────────────────────────────────────────────────┐
│              顶部工具栏  [保存修改]                        │
├─────────────┬───────────────────────────────────────────┤
│             │                                           │
│   设备树     │            寄存器列表                      │
│  (左侧面板)   │           (右侧面板)                      │
│             │ ┌─────────┬─────────┬─────────┐           │
│  连接配置     │ │ 寄存器组1│ 寄存器组2│ 寄存器组3│ (标签)     │
│  ├─从机配置   │ └─────────┴─────────┴─────────┘           │
│  │ ├─寄存器组│   地址  │ Hex │ Binary │ Int16 │ Float... │
│  │ └─寄存器组│   40002 │ ABCD│ 101010 │ -21555│ 1.234*  │
│  └─从机配置   │   ...   │ ... │  ...   │  ...  │  ...    │
│             │                                           │
└─────────────┴───────────────────────────────────────────┘
```

### 1.2 核心功能
- **设备树管理**：三层架构（连接→从机→寄存器组）的设备配置
- **寄存器编辑**：多格式数据显示和联动编辑
- **标签化显示**：点击左侧寄存器组，右侧以标签页形式展示，支持多个标签同时打开
- **手动同步**：用户主动触发前后端数据同步

## 2. 设备树功能设计

### 2.1 三层架构关系
```
连接配置 (Connection)
├── 从机配置 (Slave Device)
│   ├── 线圈 (Coil)
│   ├── 离散输入 (Discrete Input)
│   ├── 输入寄存器 (Input Register)
│   └── 保持寄存器 (Holding Register)
├── 从机配置 (Slave Device)
└── ...
```

### 2.2 配置项规范

**连接配置 (Connection)**
| 字段名 | 类型   | 默认值 | 说明     |
|--------|--------|--------|----------|
| name   | string | "连接1" | 连接名称 |

**从机配置 (Slave)**
| 字段名  | 类型   | 默认值 | 说明      |
|---------|--------|--------|-----------|
| name    | string | "从机1" | 从机名称   |
| slaveid | number | 1      | 从机地址   |

**寄存器类型 (Register Type)**
| 寄存器类型    | 地址范围        | 说明                 |
|---------------|-----------------|----------------------|
| 线圈          | 00001-09999     | Coil寄存器           |
| 离散输入      | 10001-19999     | Discrete Input寄存器  |
| 输入寄存器    | 30001-39999     | Input Register寄存器  |
| 保持寄存器    | 40001-49999     | Holding Register寄存器|

**寄存器配置 (Register)**
| 字段名    | 类型   | 默认值 | 说明                 |
|-----------|--------|--------|----------------------|
| startaddr | number | 0      | 起始逻辑地址         |
| hexdata   | string | "0000" | 连续寄存器的16进制字符串（大写，每4个十六进制字符代表1个寄存器（16位））|

### 2.3 操作菜单
```
设备树
├─ [+] 新增连接
├─ 连接1 [点击弹出菜单]
│  ├─ 新增从机 / 编辑连接 / 删除连接
│  ├─ 从机1 (地址:1) [点击弹出菜单]
│  │  ├─ 新增寄存器 / 编辑从机 / 删除从机
│  │  ├─ 线圈 [点击打开标签页]
│  │  ├─ 离散输入 [点击打开标签页]
│  │  ├─ 输入寄存器 [点击打开标签页]
│  │  └─ 保持寄存器 [点击打开标签页]
│  └─ 从机2 (地址:2)
└─ 连接2
```

#### 2.3.1 设备树标题行按钮
- 新增连接按钮

#### 2.3.2 连接配置菜单（点击连接节点弹出）
- 新增从机
- 编辑连接
- 删除连接

#### 2.3.3 从机配置菜单（点击从机节点弹出）
- 新增寄存器
- 编辑从机
- 删除从机

#### 2.3.4 寄存器配置菜单（点击寄存器节点弹出）
- 编辑寄存器
- 删除寄存器

## 3. 寄存器列表功能设计

### 3.1 左右联动机制
- **点击触发**：点击左侧设备树中的寄存器类型节点（线圈、离散输入、输入寄存器、保持寄存器）
- **标签创建**：右侧自动创建对应的寄存器类型标签页
- **多标签支持**：可同时打开多个寄存器类型的标签页
- **标签内容**：每个标签页显示该寄存器类型下的所有寄存器数据
- **标签关闭**：用户可手动关闭不需要的标签页

### 3.2 寄存器类型支持
- **线圈**（Coil）：地址范围 00001-09999
- **离散输入**（Discrete Input）：地址范围 10001-19999  
- **输入寄存器**（Input Register）：地址范围 30001-39999
- **保持寄存器**（Holding Register）：地址范围 40001-49999

### 3.2 数据列定义（寄存器型：FC03/04）
| 列名       | 描述                    | 可编辑 | 保存到后端 |
|------------|-------------------------|--------|------------|
| 地址       | Modbus逻辑地址          | ❌     | ✅         |
| Hex        | 16进制数据              | ✅     | ✅         |
| Binary     | 16位二进制显示          | ✅     | ❌         |
| Int16      | 16位有符号整数          | ✅     | ❌         |
| UInt16     | 16位无符号整数          | ✅     | ❌         |
| Float AB CD| 4字节浮点（AB CD字节序） | ✅     | ❌         |
| Float CD BA| 4字节浮点（CD BA字节序） | ✅     | ❌         |
| Float BA DC| 4字节浮点（BA DC字节序） | ✅     | ❌         |
| Float DC BA| 4字节浮点（DC BA字节序） | ✅     | ❌         |
| String     | ASCII字符串             | ✅     | ❌         |

### 3.3 位类型（FC01/02）列定义
| 列名       | 描述                                | 可编辑 | 保存到后端 |
|------------|-------------------------------------|--------|------------|
| 地址       | Modbus逻辑地址（00001/10001 起）     | ❌     | ✅         |
| ByteHex    | 所在字节的16进制显示                 | ❌     | ❌         |
| Bit        | 位值（布尔）                         | ✅     | ✅（合并成字节并组装为hexdata） |
| Binary(8)  | 该字节的二进制显示（8位）            | ✅     | ❌         |

说明：位类型数据由后端以字节为单位存储（2个hex=1字节=8位）。前端仅在“保存”时将编辑的位合并成字节并组装为 `hexdata` 发送到后端，不在前端进行持久化存储。

### 3.4 联动编辑机制
- **编辑任一可编辑列** → **自动更新其他相关列**
- **精度损失处理**：无效转换时显示"NA"
- **手动保存**：编辑完成后用户手动点击保存按钮提交到后端

### 3.5 浮点数特殊显示
- **跨寄存器显示**：每个浮点数占用连续2个寄存器（4字节）
- **滑动窗口设计**：
  - 40001-40002 → 第1行浮点数（奇数行，左对齐）
  - 40002-40003 → 第2行浮点数（偶数行，右对齐）
- **精度控制**：超过6位小数用科学计数法，保留3位小数

### 3.6 操作功能

#### 3.6.1 寄存器管理
- **添加寄存器**：地址自动分配为当前最大地址+1
- **删除寄存器**：支持单个删除

#### 3.6.2 数据保存机制
- **数据修改**：用户编辑任一可编辑列（Hex、Binary、Int16、UInt16、Float、String）
- **联动更新**：修改触发其他格式列的实时计算和显示更新
- **保存状态**：
  - 修改后数据标记为"未保存"状态（如高亮显示或加星号标记）
  - 顶部工具栏显示"保存修改"按钮
- **手动保存**：用户点击顶部工具栏的"保存修改"按钮，将修改的寄存器数据提交到后端
- **保存范围**：仅提交当前标签页中被修改的寄存器数据

## 4. API接口规范

详细的API接口规范请参考：`03_API接口规范.md`

### 4.1 三层架构实现策略
基于现有API实现三层显示：
- **获取寄存器**：使用 `GET /api/connections/{id}/slaves/{slaveId}/registers` 获取所有寄存器
- **前端分类**：根据 `startaddr` 字段按地址范围自动分类到不同寄存器类型
- **地址范围映射**：
  - 线圈：00001-09999
  - 离散输入：10001-19999  
  - 输入寄存器：30001-39999
  - 保持寄存器：40001-49999

### 4.2 数据加载策略
- **初始加载**：使用 `GET /api/connections/tree` 一次性获取连接和从机数据
- **增量更新**：增删改操作后通过相应API接口更新本地数据

### 4.3 连接树响应结构示例
```json
[
  {
    "id": "0123456789abcdef0123456789abcdef",
    "name": "主连接",
    "port": 502,
    "slaves": [
      {
        "id": "00112233445566778899aabbccddeeff",
        "connid": "0123456789abcdef0123456789abcdef",
        "name": "从机1",
        "slaveid": 1
      },
      {
        "id": "ffeeddccbbaa99887766554433221100",
        "connid": "0123456789abcdef0123456789abcdef",
        "name": "从机2",
        "slaveid": 2
      }
    ]
  }
]
```

**说明**：
- 连接树仅包含连接和从机信息，不包含寄存器数据
- 寄存器数据通过点击寄存器类型时单独加载
- 减少初始加载数据量，提高首屏加载速度

## 5. 数据模型定义

### 5.1 TypeScript接口
```typescript
// 连接配置
interface Connection {
  id: string;      -- 32位无横杠UUID
  name: string;    -- 连接名称
  port: number;    -- 端口号（新增连接时自动分配，从502开始递增）
}

// 从机配置
interface Slave {
  id: string;         -- 32位无横杠UUID
  connid: string;    -- 所属连接ID
  name: string;       -- 从机名称
  slaveid: number;    -- 从机地址（1-247）
}

// 寄存器配置
interface Register {
  id: string;         -- 32位无横杠UUID
  slaveid: string;   -- 所属从机ID
  startaddr: number;  -- 起始逻辑地址（前端根据此字段判断寄存器类型）
  hexdata: string;    -- 16进制字符串（大写、无0x前缀）
}

// 组合查询结果
interface ConnectionTree {
  id: string;
  name: string;
  port: number;    -- 端口号（新增连接时自动分配，从502开始递增）
  slaves: Slave[];
}
```

### 5.2 创建请求格式
```typescript
interface CreateConnectionRequest {
  name: string;
}

interface CreateSlaveRequest {
  name: string;
  slaveid: number;
}

interface CreateRegisterRequest {
  startaddr: number;  -- 起始地址决定寄存器类型
  hexdata: string;
}
```

## 6. 数据转换与同步策略

### 6.1 数据存储模式
- **后端存储**：每个Register记录包含起始地址`startaddr`和连续寄存器的16进制字符串`hexdata`
- **数据块示例**：`startaddr=40001, hexdata="0000ABCD1234"`表示40001-40003三个连续寄存器
- **前端解析**：将hexdata按每4个十六进制字符拆分为单个16位寄存器值进行显示和编辑

### 6.2 转换规则
- **前端实时转换**：Binary、Int16、UInt16、Float、String等格式
- **联动更新**：编辑任一格式触发重新计算其他格式，最终组装回hexdata

### 6.3 默认值规则
**新增寄存器时**：
- **地址**：当前最大地址+1
- **Hex**：默认"0000"

### 6.4 关联字段自动处理
- `connid`：从机创建时自动关联到父级连接
- `slaveid`：寄存器创建时自动关联到父级从机
- 用户无需填写，界面上不显示这些关联字段

## 7. 响应格式约定

详细的响应格式约定请参考：`03_API接口规范.md`

### 7.1 前端错误处理
- **错误格式**：按照03_API接口规范.md中定义的 `{ "error": "错误描述", "code": 400 }` 格式处理
- **状态码处理**：
  - 400：业务验证失败，显示具体错误信息
  - 404：资源不存在，显示友好提示
  - 409：数据冲突，提示用户重新操作
  - 500：服务器错误，显示通用错误提示

---

**最后更新**：2025-08-31  
**状态**：设计规范，待开发实现